!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.BrowserPeer=t()}(this,function(){"use strict";function e(){var e,t,n="";for(e=0;32>e;e++)t=16*Math.random()|0,8!==e&&12!==e&&16!==e&&20!==e||(n+="-"),n+=(12===e?4:16===e?3&t|8:t).toString(16);return n}function t(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}function n(e){return"function"==typeof e}var i=function(){function e(e,t){for(var n=0;t.length>n;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._eventMap=new Map}return i(e,[{key:"addListener",value:function(e,t){var i=this;if(!n(t))throw new TypeError("listener must be a function");return e.split(" ").forEach(function(e){i._eventMap.has(e)||i._eventMap.set(e,[]),i.listeners(e).push(t)}),this}},{key:"on",value:function(){return this.addListener.apply(this,arguments)}},{key:"once",value:function(e,t){if(!n(t))throw new TypeError("listener must be a function");var i=!1;function o(){this.removeListener(e,o),i||(i=!0,t.apply(this,arguments))}return o.callback=t,this.on(e,o),this}},{key:"removeListener",value:function(e,t){if(!n(t))throw new TypeError("listener must be a function");var i=this.listeners(e),o=i.filter(function(e){return e!==t});if(i!==o)return this._eventMap.set(e,o),this}},{key:"off",value:function(){return this.removeListener.apply(this,arguments)}},{key:"removeAllListeners",value:function(e){return this._eventMap.delete(e)}},{key:"emit",value:function(e){for(var t=this,n=arguments.length,i=Array(n>1?n-1:0),o=1;n>o;o++)i[o-1]=arguments[o];var r=this.listeners(e);if(r&&r.length)return r.forEach(function(e){return e.apply(t,i)}),this}},{key:"listeners",value:function(e){return this._eventMap.get(e)}}],[{key:"listenerCount",value:function(e,t){return e.listenerCount(t)}}]),e}(),r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;t.length>n;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var a="undefined"!=typeof window&&!!window.webkitRTCPeerConnection;function c(){}return function(n){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,o);function i(n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));if(o._id=e().substr(0,8),o.opts=Object.assign({allowHalfOpen:!1,debug:!1},n),o.channelName=o.opts.initiator?o.opts.channelName||e():null,o.initiator=o.opts.initiator||!1,o.channelConfig=o.opts.channelConfig||i.channelConfig,o.config=o.opts.config||i.config,o.constraints=i.transformConstraints(o.opts.constraints||i.constraints),o.offerConstraints=i.transformConstraints(o.opts.offerConstraints||{}),o.answerConstraints=i.transformConstraints(o.opts.answerConstraints||{}),o.reconnectTimer=o.opts.reconnectTimer||!1,o.sdpTransform=o.opts.sdpTransform||function(e){return e},o.stream=o.opts.stream||!1,o.trickle=void 0===o.opts.trickle||o.opts.trickle,o._earlyMessage=null,o.destroyed=!1,o.connected=!1,o.remoteAddress=void 0,o.remoteFamily=void 0,o.remotePort=void 0,o.localAddress=void 0,o.localPort=void 0,o._wrtc=o.opts.wrtc&&"object"===r(o.opts.wrtc)?o.opts.wrtc:t(),!o._wrtc)throw Error("No WebRTC support: Not a supported browser");if(o._pcReady=!1,o._channelReady=!1,o._iceComplete=!1,o._channel=null,o._pendingCandidates=[],o._previousStreams=[],o._chunk=null,o._cb=null,o._interval=null,o._reconnectTimeout=null,o._pc=new o._wrtc.RTCPeerConnection(o.config,o.constraints),o._pc.oniceconnectionstatechange=function(){o._onIceStateChange()},o._pc.onicegatheringstatechange=function(){o._onIceStateChange()},o._pc.onsignalingstatechange=function(){o._onSignalingStateChange()},o._pc.onicecandidate=function(e){o._onIceCandidate(e)},o.initiator){var s=!1;o._pc.onnegotiationneeded=function(){s||o._createOffer(),s=!0},o._setupData({channel:o._pc.createDataChannel(o.channelName,o.channelConfig)})}else o._pc.ondatachannel=function(e){o._setupData(e)};return"addTrack"in o._pc?o._pc.ontrack=function(e){o._onTrack(e)}:o._pc.onaddstram=function(e){o._onAddStram(e)},o.initiator&&o._isWrtc&&o._pc.onnegotiationneeded(),o._onFinishBound=function(){o._onFinish()},o.once("finish",o._onFinishBound),o}return s(i,[{key:"signal",value:function(e){var t=this;if(this.destroyed)throw Error("cannot signal after peer is destroyed");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}e.candidate&&(this._pc.remoteDescription?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e),function(){t.destroyed||(t._pendingCandidates.forEach(function(e){return t._addIceCandidate(e)}),t._pendingCandidates=[],"offer"===t._pc.remoteDescription.type&&t._createAnswer())},function(e){t._destroy(e)}),e.sdp||e.candidate||this._destroy(Error("signal() called with invalid signal data"))}},{key:"send",value:function(e){this._channel.send(e)}},{key:"destroy",value:function(e){this._destroy(null,e)}},{key:"getStats",value:function(e){0===this._pc.getStats.length?this._pc.getStats().then(function(t){var n=[];t.forEach(function(e){n.push(e)}),e(null,n)},function(t){e(t)}):this._pc.getStats.length>0?this._pc.getStats(function(t){if(!this.destroyed){var n=[];t.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),e(null,n)}},function(t){e(t)}):e(null,[])}},{key:"_addIceCandidate",value:function(e){try{this._pc.addIceCandidate(new this._wrtc.RTCIceCandidate(e),c,function(e){this._destroy(e)})}catch(e){this._destroy(Error("error adding candidate: "+e.message))}}},{key:"_destroy",value:function(e,t){if(!this.destroyed){if(t&&this.once("close",t),this._debug("destroy (error: %s)",e&&(e.message||e)),this.destroyed=!0,this.connected=!1,this._pcReady=!1,this._channelReady=!1,this._previousStreams=null,this._earlyMessage=null,clearInterval(this._interval),clearTimeout(this._reconnectTimeout),this._interval=null,this._reconnectTimeout=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.off("finish",this._onFinishBound),this._onFinishBound=null,this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,"addTrack"in this._pc?this._pc.ontrack=null:this._pc.onaddstream=null,this._pc.onnegotiationneeded=null,this._pc.ondatachannel=null}if(this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}}},{key:"_setupData",value:function(e){var t=this;if(!e.channel)return this._destroy(Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=65536),this.channelName=this._channel.label,this._channel.onmessage=function(e){t._channelReady?t._onChannelMessage(e):(t._earlyMessage=e,t._onChannelOpen())},this._channel.onbufferedamountlow=function(){t._onChannelBufferedAmountLow()},this._channel.onopen=function(){t._channelReady||t._onChannelOpen()},this._channel.onclose=function(){t._onChannelClose()},this._channel.onerror=function(e){t._destroy(e)}}},{key:"_write",value:function(e,t,n){if(this.destroyed)return n(Error("cannot write after peer is destroyed"));if(this.connected){try{this.send(e)}catch(e){return this._destroy(e)}this._channel.bufferedAmount>65536?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=n):n(null)}else this._debug("write before connect"),this._chunk=e,this._cb=n}},{key:"_createOffer",value:function(){var e=this;this.destroyed||this._pc.createOffer(function(t){var n=function(){var n=e._pc.localDescription||t;e._debug("signal"),e.emit("signal",{type:n.type,sdp:n.sdp})};e.destroyed||(t.sdp=e.sdpTransform(t.sdp),e._pc.setLocalDescription(t,function(){e.destroyed||(e.trickle||e._iceComplete?n():e.once("_iceComplete",n))},function(t){e._destroy(t)}))},function(e){this._destroy(e)},this.offerConstraints)}},{key:"_createAnswer",value:function(){var e=this;this.destroyed||this._pc.createAnswer(function(t){var n=function(){var n=e._pc.localDescription||t;e._debug("signal"),e.emit("signal",{type:n.type,sdp:n.sdp})};e.destroyed||(t.sdp=e.sdpTransform(t.sdp),e._pc.setLocalDescription(t,function(){e.destroyed||(e.trickle||e._iceComplete?n():e.once("_iceComplete",n))},function(t){e._destroy(t)}))},function(e){this._destroy(e)},this.answerConstraints)}},{key:"_onIceStateChange",value:function(){if(!this.destroyed){var e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(clearTimeout(this._reconnectTimeout),this._pcReady=!0,this._maybeReady()),"disconnected"===e&&(this.reconnectTimer?(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=setTimeout(function(){this._destroy()},this.reconnectTimer)):this._destroy()),"failed"===e&&this._destroy(Error("Ice connection failed.")),"closed"===e&&this._destroy()}}},{key:"_maybeReady",value:function(){var e=this;if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),!this.connected&&!this._connecting&&this._pcReady&&this._channelReady){this._connecting=!0;!function t(){e.destroyed||e.getStats(function(n,i){if(!e.destroyed){n&&(i=[]);var o={},r={},s={},a=!1,c=function(t){a=!0;var n=r[t.localCandidateId];n&&n.ip?(e.localAddress=n.ip,e.localPort=+n.port):n&&n.ipAddress?(e.localAddress=n.ipAddress,e.localPort=+n.portNumber):"string"==typeof t.googLocalAddress&&(n=t.googLocalAddress.split(":"),e.localAddress=n[0],e.localPort=+n[1]);var i=o[t.remoteCandidateId];i&&i.ip?(e.remoteAddress=i.ip,e.remotePort=+i.port):i&&i.ipAddress?(e.remoteAddress=i.ipAddress,e.remotePort=+i.portNumber):"string"==typeof t.googRemoteAddress&&(i=t.googRemoteAddress.split(":"),e.remoteAddress=i[0],e.remotePort=+i[1]),e.remoteFamily="IPv4",e._debug("connect local: %s:%s remote: %s:%s",e.localAddress,e.localPort,e.remoteAddress,e.remotePort)};if(i.forEach(function(e){"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(o[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(r[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(s[e.id]=e)}),i.forEach(function(e){"transport"===e.type&&c(s[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&c(e)}),a||!i.length){if(e._connecting=!1,e.connected=!0,e._chunk){try{e.send(e._chunk)}catch(n){return e._destroy(n)}e._chunk=null,e._debug('sent chunk from "write before connect"');var d=e._cb;e._cb=null,d(null)}"number"!=typeof e._channel.bufferedAmountLowThreshold&&(e._interval=setInterval(e._onInterval,150),e._interval.unref&&e._interval.unref()),e._debug("connect"),e.emit("connect"),e._earlyMessage&&(e._onChannelMessage(e._earlyMessage),e._earlyMessage=null)}else setTimeout(t,100)}})}()}}},{key:"_onFinish",value:function(){this.destroyed||(this.connected?e():this.once("connect",e));function e(){setTimeout(function(){this._destroy()},1e3)}}},{key:"_onInterval",value:function(){this._cb&&this._channel&&65536>=this._channel.bufferedAmount&&this._onChannelBufferedAmountLow()}},{key:"_onSignalingStateChange",value:function(){this.destroyed||(this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}},{key:"_onIceCandidate",value:function(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||(this._iceComplete=!0,this.emit("_iceComplete")))}},{key:"_onChannelMessage",value:function(e){if(!this.destroyed){var t=e.data;t instanceof ArrayBuffer&&(t=Buffer.from(t)),this.emit("data",t)}}},{key:"_onChannelBufferedAmountLow",value:function(){if(!this.destroyed&&this._cb){this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);var e=this._cb;this._cb=null,e(null)}}},{key:"_onChannelOpen",value:function(){this.connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}},{key:"_onChannelClose",value:function(){this.destroyed||(this._debug("on channel close"),this._destroy())}},{key:"_onTrack",value:function(e){if(!this.destroyed){this._debug("on track");var t=e.streams[0].id;-1===this._previousStreams.indexOf(t)&&(this._previousStreams.push(t),this.emit("stream",e.streams[0]))}}},{key:"_debug",value:function(e){this.opts.debug&&console.debug(e)}},{key:"bufferSize",get:function(){return this._channel&&this._channel.bufferedAmount||0}},{key:"address",get:function(){return{port:this.localPort,family:function(e){if(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e))return"IPv4";if(/(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))/.test(e))return"IPv6";throw Error(e+" is not a valid IPv4 or IPv6 address.")}(this.localAddress),address:this.localAddress}}}],[{key:"transformConstraints",value:function(e){if(0===Object.keys(e).length)return e;if((e.mandatory||e.optional)&&!a){var t=Object.assign({},e.optional,e.mandatory);return void 0!==t.OfferToReceiveVideo&&(t.offerToReceiveVideo=t.OfferToReceiveVideo,delete t.OfferToReceiveVideo),void 0!==t.OfferToReceiveAudio&&(t.offerToReceiveAudio=t.OfferToReceiveAudio,delete t.OfferToReceiveAudio),t}return e.mandatory||e.optional||!a?e:(void 0!==e.offerToReceiveVideo&&(e.OfferToReceiveVideo=e.offerToReceiveVideo,delete e.offerToReceiveVideo),void 0!==e.offerToReceiveAudio&&(e.OfferToReceiveAudio=e.offerToReceiveAudio,delete e.offerToReceiveAudio),{mandatory:e})}},{key:"config",get:function(){return{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}]}}},{key:"WEBRTC_SUPPORT",get:function(){return!!t()}},{key:"channelConfig",get:function(){return{}}},{key:"constraints",get:function(){return{}}}]),i}()});
